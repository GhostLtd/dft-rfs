steps:
    # Install dependencies
    - name: node
      id: 'node-install'
      entrypoint: yarn
      args: ['install', '--frozen-lockfile']
    # Run custom commands
    - name: node
      id: 'node-build'
      entrypoint: yarn
      args: ['run', 'deploy-build']
      waitFor: ['node-install']

    # copy common app deploy files
    - name: "gcr.io/google.com/cloudsdktool/cloud-sdk:alpine"
      id: 'copy-common-deploy-files'
      args: ['gsutil', 'cp', 'config/gcloud-build/all/*', '.']
      waitFor: ['-']
    # copy project specific app deploy files
    - name: "gcr.io/google.com/cloudsdktool/cloud-sdk:alpine"
      id: 'copy-project-deploy-files'
      args: ['gsutil', 'cp', 'config/gcloud-build/$PROJECT_ID/*', '.']
      waitFor: ['copy-common-deploy-files']

    # deploy default service
    - name: "gcr.io/cloud-builders/gcloud"
      id: 'deploy-default-service'
      args: ["app", "deploy", "app.default.yaml"]
      waitFor: ['node-build', 'copy-project-deploy-files']
    # deploy admin service
    - name: "gcr.io/cloud-builders/gcloud"
      id: 'deploy-admin-service'
      args: ["app", "deploy", "app.admin.yaml"]
      waitFor: ['node-build', 'copy-project-deploy-files']

timeout: "900s"
